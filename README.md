# CSCI 662 Group project


# Information of codes base in orgiinal KEMI paper

The model and analysis implementation of _Knowledge-enhanced Mixed-initiative Dialogue System for Emotional Support Conversations_ (ACL 2023), which can be downloaded via this [url](https://drive.google.com/drive/folders/1gFlgKxda5O-RSbb3lhaj6oXiopgAsJKg?usp=sharing).

The original code is built upon this [repo](https://github.com/thu-coai/Emotional-Support-Conversation/tree/main/codes_zcj).

==================================================================
# Reproduction Works

## Preparing Enviroment

```bash
conda env create -f env.yml -n cuda
conda activate cuda
```

## To run the codes for training, you should first download model files from the link of google drive. Then, you should put them into the right location.
- [google drive link](https://drive.google.com/drive/folders/1aNfWwn9un3r4XYrUf2Xy2PzuuQjLaJY3?usp=sharing)
- files in the "wordvector" dirctory -> ./wordvector
- files in the "model" directory -> ./metric/model
- files in the "Blenderbot_small-90M" directory -> ./Blenderbot_small-90M


## Run the code
### KEMI model
1. Run 'bash RUN/prepare_strat.sh' to prepare the data.
2. Run 'bash RUN/train_strat.sh' to train the model.
3. Run 'bash RUN/infer_strat.sh' to evaluate the model.

### Vanila model (wo/ knoweldge injection & strategy prediction)
1. Run 'bash RUN/prepare_vanila.sh' to prepare the data.
2. Run 'bash RUN/train_vanila.sh' to train the model.
3. Run 'bash RUN/infer_vanila.sh' to evaluate the model.

### KEMI model (w/ knoweldge injection + wo/ Strategy prediction )
1. Run 'bash RUN/prepare_know_wo_strat.sh' to prepare the data.
2. Run 'bash RUN/train_know_wo_strat.sh' to train the model.
3. Run 'bash RUN/infer_know_wo_strat.sh' to evaluate the model.

### Empathetic T5 (wo/ knoweldge injection + wo/ Strategy prediction )
1. Run 'bash RUN/prepare_vanila_t5.sh' to prepare the data.
2. Run 'bash RUN/train_vanila_t5.sh' to train the model.
3. Run 'bash RUN/infer_vanila_t5.sh' to evaluate the model.

### Blenderbot augmented with AugESC (wo/ knoweldge injection + wo/ Strategy prediction )
Before running the script, training set of AugESC should be in "./_reformat/AugESC/combined_train.txt"
* "combined_train.txt" refers to the dataset combined with ESConv dataset after being preprocessed with the same manner in KEMI paper. It can be downloaded here [url](https://drive.google.com/file/d/1Qghab_aMe02FABmfH-8FnJ1eD6YeMQOL/view?usp=drive_link)
1. Run 'bash RUN/prepare_vanila_blenderbot_AugESC.sh' to prepare the data.
2. Run 'bash RUN/train_vanila_blenderbot_AugESC.sh' to train the model.
3. Run 'bash RUN/infer_vanila_blenderbot_AugESC.sh' to evaluate the model.

Check generating_augesc_datasets.py for dataset generation details. 

### Ablations: KEMI wo/ specific knoweldge types (Affective, Casusal, Cognitive)
Before runnign the script, the file without specific knowledge should be in "./_reformat/ds_esconv_datasets/sbert_wo_{affective/causal/cognitive}/(train/test/valid).txt"
- "ds_esconv_datasets" can be downloaded here [url](https://drive.google.com/file/d/1HjfcCcBwSUkC87RjL1Hgj7QMGmxuOQZe/view?usp=drive_link)
1. Run 'bash RUN/prepare_strat_wo_know_type.sh' to prepare the data.
2. Run 'bash RUN/train_strat_wo_know_type.sh' to train the model.
3. Run 'bash RUN/infer_strat_wo_know_type.sh' to evaluate the model.

### Ablations: KEMI w/ new knoweldge generated by GPT
Before runnign the script, the files with knowledge from GPT should be in "./_reformat/ds_esconv_gpt/sbet_gpt/(train/test/valid).txt"
- "ds_esconv_gpt" can be downloaded here [url](https://drive.google.com/file/d/15V43bddiDouVL1MUsIDwLAz8Gl4U3NEe/view?usp=drive_link)
1. Run 'bash RUN/prepare_strat_w_know_gpt.sh' to prepare the data.
2. Run 'bash RUN/train_strat_w_know_gpt.sh' to train the model.
3. Run 'bash RUN/infer_strat_w_know_gpt.sh' to evaluate the model.
- Regarding generating new knowledge by GPT3, please check this code: gpt_augment/augment.py

### For Checking Cross-attention weights of the models
Check the ipynb file named as bertviz.ipynb
